@startuml seq-failure
title Payment Flow - Failure Scenario

participant Customer
participant BFF
participant Wallet
participant "Wallet DB" as WalletDB
participant "Kafka Connect" as KC
participant Kafka
participant Payment
participant "Payment DB" as PaymentDB
participant "Anti-Fraud" as AntiFraud
participant "Provider\n<<external>>" as Provider
participant "Callback Service" as Callback
participant "Callback DB" as CallbackDB
participant Query
participant "Query DB" as QueryDB

== Reserve ==

Customer -> BFF: POST /payments
BFF -> Wallet: POST /wallets/{walletId}/reservations
Wallet -> WalletDB: write transaction (RESERVED)\n+ outbox (PaymentInitiated)
Wallet --> BFF: paymentId
BFF --> Customer: 202 Accepted

== Publish Event (CDC) ==

KC -> WalletDB: read WAL
KC -> Kafka: PaymentInitiated

== Process Payment ==

Kafka -> Payment: PaymentInitiated
Payment -> PaymentDB: write payment (PROCESSING)
Payment -> AntiFraud: check risk (gRPC)
AntiFraud --> Payment: ALLOW
Payment -> Provider: POST /payments
Provider --> Payment: 202 Accepted {providerTxnId}
Payment -> PaymentDB: save providerTxnId, status=PROCESSING

== Provider Callback (FAILURE) ==

Provider -> Callback: POST /callbacks
Callback -> CallbackDB: save callback + outbox (ProviderCallbackReceived)
KC -> CallbackDB: read WAL
KC -> Kafka: ProviderCallbackReceived
Kafka -> Payment: ProviderCallbackReceived
Payment -> PaymentDB: update (FAILED)\n+ outbox (PaymentFailed)

== Publish Failure (CDC) ==

KC -> PaymentDB: read WAL
KC -> Kafka: PaymentFailed

== Compensate: Release ==

Kafka -> Wallet: PaymentFailed
Wallet -> WalletDB: release (FAILED)

== Update Read Model ==

Kafka -> Query: PaymentFailed
Query -> QueryDB: update projection

@enduml
