@startuml erd-wallet
hide circle

entity "wallets" {
  * id : uuid <<PK>>
  --
  * user_id : uuid
  * balance : bigint
  * reserved : bigint
  * currency : text
  * created_at : timestamptz
  * updated_at : timestamptz
  --
  <<CHECK>> balance >= 0
  <<CHECK>> reserved >= 0
  <<CHECK>> reserved <= balance
  --
  <<INDEX>> idx_wallets_user_id (user_id)
}

entity "reservations" {
  * id : uuid <<PK>>
  --
  * payment_id : uuid <<UNIQUE>>
  * wallet_id : uuid <<FK>>
  * amount : bigint
  * status : text
  * created_at : timestamptz
  * committed_at : timestamptz
  * released_at : timestamptz
  --
  <<CHECK>> amount > 0
  <<CHECK>> status IN ('RESERVED', 'COMMITTED', 'RELEASED')
  --
  <<INDEX>> idx_reservations_wallet_id (wallet_id)
}

entity "wallet_outbox" {
  * id : uuid <<PK>>
  --
  * payment_id : uuid
  * event_type : text
  * payload : jsonb
  * created_at : timestamptz
  * published_at : timestamptz
}

wallets ||--o{ reservations

@enduml
