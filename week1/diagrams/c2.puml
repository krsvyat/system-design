@startuml C4_Container_Payment_Platform
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_TOP_DOWN()

title Container diagram for Payment Platform

Person(user, "Customer", "Bank customer")

Container(mobile, "Mobile App", "iOS/Android", "Mobile banking app")
Container(web, "Web App", "React", "Web banking app")

System_Boundary(payment_platform, "Payment Platform") {
    Container(gateway, "API Gateway", "Kong", "Token validation, rate limiting, routing")
    Container(bff, "BFF", "Ktor", "API for clients")
    Boundary(payments_ctx, "Payments Context") {
        Container(payments, "Payments", "Spring", "Payment lifecycle")
        Container(card_adapter, "Card Adapter", "Spring", "ISO 8583 integration")
        Container(bank_adapter, "Bank Adapter", "Spring", "SBP, SWIFT integration")
        ContainerDb(payments_db, "Payments DB", "PostgreSQL", "Payments, statuses")
        Rel(payments, payments_db, "")
        Rel(payments, card_adapter, "", "HTTP")
        Rel(payments, bank_adapter, "", "HTTP")
    }

    Boundary(customer_ctx, "Customer Context") {
        Container(customer, "Customer", "Spring", "Customer data, KYC")
        ContainerDb(customer_db, "Customer DB", "PostgreSQL", "Customers, consents, documents")
        ContainerDb(customer_cache, "Customer Cache", "Redis", "Customer cache")
        Rel(customer, customer_db, "")
        Rel(customer, customer_cache, "")
    }
    Boundary(auth_ctx, "Auth Context") {
        Container(auth, "Auth", "Go", "Login, tokens, MFA")
        ContainerDb(auth_db, "Auth DB", "PostgreSQL", "Credentials, devices, login history")
        ContainerDb(auth_cache, "Auth Cache", "Redis", "Sessions, tokens")
        Rel(auth, auth_db, "")
        Rel(auth, auth_cache, "")
    }

    Boundary(antifraud_ctx, "Anti-Fraud Context") {
        Container(antifraud, "Anti-Fraud", "Spring", "Risk scoring, decisions")
        Container(antifraud_ml, "ML Scoring", "Python, FastAPI", "Runs fraud detection")
        ContainerDb(antifraud_models, "Model Registry", "MLflow", "Trained models")
        ContainerDb(antifraud_db, "Anti-Fraud DB", "PostgreSQL", "Rules, blacklists")
        ContainerDb(antifraud_events, "Events Store", "ClickHouse", "Transaction history")
        Rel(antifraud, antifraud_ml, "", "HTTP")
        Rel(antifraud, antifraud_db, "")
        Rel(antifraud_ml, antifraud_models, "")
        Rel(antifraud_ml, antifraud_events, "")
    }

    Boundary(callbacks_ctx, "Callbacks Context") {
        Container(callbacks, "Callbacks", "Spring", "Webhook delivery, retry")
        ContainerDb(callbacks_db, "Callbacks DB", "PostgreSQL", "Delivery status, merchant settings")
        Rel(callbacks, callbacks_db, "")
    }

    Boundary(core_banking_ctx, "Core Banking Context") {
        Container(core_banking_acl, "Core Banking ACL", "Spring", "Translates Kafka to IBM MQ, maps domain terms")
        Container(core_banking, "Core Banking", "COBOL, Mainframe", "Accounting, debit/credit entries")
        ContainerDb(core_banking_db, "Core Banking DB", "IBM DB2", "Accounting entries, history")
        Rel(core_banking_acl, core_banking, "", "IBM MQ")
        Rel(core_banking, core_banking_db, "", "SQL")
    }

    Boundary(account_ctx, "Account Context") {
        Container(account, "Account", "Spring", "Manages balances, holds")
        ContainerDb(account_db, "Account DB", "PostgreSQL", "Balances, holds")
        ContainerDb(account_cache, "Account Cache", "Redis", "Balance cache")
        Rel(account, account_db, "")
        Rel(account, account_cache, "")
    }

    Boundary(notifications_ctx, "Notifications Context") {
        Container(notifications, "Notifications", "Go", "Routing, fallback, delivery")
    }

}

' External systems (positioned at bottom)
System_Ext(card_processing, "Card Processing", "Visa, Mastercard, MIR")
System_Ext(other_banks, "Other Banks", "SBP, SWIFT")
System_Ext(merchants, "Merchants", "Online stores")
System_Ext(fcm, "FCM / APNs", "Push notifications")
System_Ext(sms_gateway, "SMS Gateway", "SMS delivery")
System_Ext(smtp, "SMTP Provider", "Email delivery")
System_Ext(central_bank, "Central Bank", "Regulatory reporting")
System_Ext(dwh, "DWH", "Analytics and reporting")

Lay_D(payment_platform, card_processing)
Lay_D(payment_platform, other_banks)
Lay_D(payment_platform, merchants)
Lay_D(payment_platform, fcm)
Lay_D(payment_platform, sms_gateway)
Lay_D(payment_platform, smtp)
Lay_D(payment_platform, central_bank)
Lay_D(payment_platform, dwh)

' User -> Apps
Rel(user, mobile, "Uses")
Rel(user, web, "Uses")

' Apps -> Gateway -> BFF
Rel(mobile, gateway, "", "HTTPS")
Rel(web, gateway, "", "HTTPS")
Rel(gateway, bff, "", "HTTP")
Rel(gateway, auth, "Validate token", "gRPC")

' Auth -> Anti-Fraud, Notifications
Rel(auth, antifraud, "Check login", "HTTP")
Rel(auth, notifications, "Send one time password", "async")

' Anti-Fraud -> Customer
Rel(antifraud, customer, "Get risk profile", "HTTP")

' BFF -> internal services
Rel(bff, auth, "Authenticate", "gRPC")
Rel(bff, payments, "Create payment", "HTTP")
Rel(bff, account, "Get accounts", "HTTP")
Rel(bff, customer, "Get customer", "HTTP")

' Payments -> internal services
Rel(payments, antifraud, "Check payment", "gRPC")
Rel(payments, account, "Hold, Capture", "gRPC")
Rel(payments, core_banking_acl, "Capture", "async")
Rel(payments, notifications, "Send notification", "async")
Rel(payments, callbacks, "Send callback", "async")

' Adapters -> external systems
Rel_D(card_adapter, card_processing, "Card payments", "ISO 8583")
Rel_D(bank_adapter, other_banks, "Transfers", "API")

' Callbacks -> external
Rel_D(callbacks, merchants, "Webhook delivery", "HTTP")

' Customer -> Account
Rel(customer, account, "CustomerCreated", "async")

' Account -> Notifications
Rel(account, notifications, "Balance changed", "async")

' Notifications -> external
Rel_D(notifications, fcm, "Push", "HTTP")
Rel_D(notifications, sms_gateway, "SMS", "HTTP")
Rel_D(notifications, smtp, "Email", "SMTP")

' Core Banking ACL -> Central Bank
Rel_D(core_banking_acl, central_bank, "Reporting", "batch")

' Payments -> DWH
Rel_D(payments, dwh, "Events", "async")

@enduml
