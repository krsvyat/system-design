# Containers

Описание всех контейнеров платёжной платформы (C2 level).

## Infrastructure

### API Gateway (Kong)

Единая точка входа для внешних запросов. Все клиенты (mobile, web, external) обращаются только сюда.

**Задачи:**

- Валидация JWT токенов (проверка подписи, expiration)
- Rate limiting per client/IP, защита от DDoS
- Маршрутизация запросов к BFF или напрямую к сервисам
- Генерация `X-Request-ID` для сквозного трейсинга
- Логирование всех входящих запросов
- TLS termination

**Входящие:**

| От кого            | Протокол   | Описание                  |
| ------------------ | ---------- | ------------------------- |
| Mobile/Web клиенты | HTTPS/REST | Клиентские запросы        |
| External Providers | HTTPS/REST | Callback'и от провайдеров |

**Исходящие:**

| Куда             | Протокол  | Описание               |
| ---------------- | --------- | ---------------------- |
| BFF              | HTTP/REST | Клиентские запросы     |
| Callback Service | HTTP/REST | Callback'и провайдеров |

**Почему Kong:** nginx под капотом, много плагинов (rate-limit, JWT, logging), enterprise поддержка.

### BFF (Backend for Frontend)

Агрегирует данные для клиентов. Скрывает внутреннюю структуру системы — клиент не знает о Wallet, Payment, Query сервисах.

**Задачи:**

- Оркестрация запросов к внутренним сервисам
- Адаптация ответов под тип клиента (mobile получает меньше данных)
- Композиция данных из нескольких сервисов в один ответ
- Трансляция ошибок в клиентский формат

**Входящие:**

| От кого     | Протокол  | Описание               |
| ----------- | --------- | ---------------------- |
| API Gateway | HTTP/REST | Все клиентские запросы |

**Исходящие:**

| Куда             | Протокол    | Описание                           |
| ---------------- | ----------- | ---------------------------------- |
| Wallet Service   | HTTP (sync) | Резервирование средств             |
| Query Service    | HTTP (sync) | Получение статуса/истории платежей |
| Customer Service | HTTP (sync) | Данные клиента                     |

## Core Services

### Wallet Service

Владеет балансами пользователей. Единственный сервис, который может изменять баланс. Реализует паттерн Reserve/Commit/Release для атомарных операций.

**Задачи:**

- Хранение балансов пользователей
- Резервирование средств при создании платежа
- Commit (списание) при успешном платеже
- Release (возврат резерва) при неуспешном платеже
- Создание кошелька при регистрации пользователя

**ERD:** [Wallet DB](database.md#wallet-db)

**Входящие:**

| От кого | Протокол    | Описание                              |
| ------- | ----------- | ------------------------------------- |
| BFF     | HTTP (sync) | `POST /reservations` — резервирование |
| Kafka   | async       | `PaymentCompleted` → commit           |
| Kafka   | async       | `PaymentFailed` → release             |
| Kafka   | async       | `CustomerCreated` → создать кошелёк   |

**Исходящие:**

| Куда  | Протокол       | Описание                                |
| ----- | -------------- | --------------------------------------- |
| Kafka | async (outbox) | `PaymentInitiated` после резервирования |

### Payment Service

Жизненный цикл платежа. Получает событие о резервировании, вызывает провайдера, обрабатывает результат.

**Задачи:**

- Создание записи платежа при получении `PaymentInitiated`
- Выбор провайдера (routing по валюте, сумме, доступности)
- Вызов внешнего провайдера
- Обработка callback'ов (через событие `ProviderCallbackReceived`)
- Timeout handling — если callback не пришёл за N минут

**ERD:** [Payment DB](database.md#payment-db)

**Входящие:**

| От кого | Протокол | Описание                                     |
| ------- | -------- | -------------------------------------------- |
| Kafka   | async    | `PaymentInitiated` → начать обработку        |
| Kafka   | async    | `ProviderCallbackReceived` → обновить статус |

**Исходящие:**

| Куда              | Протокол        | Описание                                                               |
| ----------------- | --------------- | ---------------------------------------------------------------------- |
| Anti-Fraud        | gRPC (sync)     | Проверка перед отправкой провайдеру                                    |
| Payment Providers | ISO 8583, SWIFT | POST /payments (timeout 30 сек, 3 retry), POST /reversals, GET /status |
| Kafka             | async (outbox)  | `PaymentCompleted` или `PaymentFailed`                                 |

### Anti-Fraud Service

Real-time проверка операций. Вызывается синхронно — платёж ждёт решения.

**Задачи:**

- Scoring платежей (сумма, частота, геолокация, device fingerprint)
- Scoring логинов (новое устройство, подозрительный IP)
- Rule-based проверки (чёрные списки, лимиты)
- ML-модель для аномалий
- Решение: ALLOW / DENY / REVIEW
- Сбор истории платежей для ML-обучения

**Входящие:**

| От кого         | Протокол    | Описание                           |
| --------------- | ----------- | ---------------------------------- |
| Payment Service | gRPC (sync) | Проверка платежа перед провайдером |
| Auth Service    | gRPC (sync) | Проверка логина                    |
| Kafka           | async       | Payment events → ClickHouse для ML |

**Исходящие:** Нет

## Supporting Services

### Auth Service

Аутентификация пользователей. Выдаёт JWT токены, управляет сессиями.

**Задачи:**

- Login/logout
- MFA (SMS, TOTP)
- Выдача access/refresh токенов
- Валидация токенов для других сервисов
- Session management (revoke, list active)

**Входящие:**

| От кого     | Протокол  | Описание             |
| ----------- | --------- | -------------------- |
| API Gateway | gRPC      | Валидация токена     |
| Clients     | HTTP/REST | Login, refresh token |

**Исходящие:**

| Куда       | Протокол    | Описание                            |
| ---------- | ----------- | ----------------------------------- |
| Anti-Fraud | gRPC (sync) | Проверка логина на подозрительность |

### Customer Service

Данные клиентов и KYC. Единственный владелец профилей пользователей.

**Задачи:**

- Регистрация пользователей
- Хранение профилей (имя, контакты)
- KYC документы и статусы верификации
- Уровни лимитов на основе KYC

**Входящие:**

| От кого | Протокол    | Описание                        |
| ------- | ----------- | ------------------------------- |
| BFF     | HTTP (sync) | Регистрация, обновление профиля |

**Исходящие:**

| Куда  | Протокол       | Описание                                   |
| ----- | -------------- | ------------------------------------------ |
| Kafka | async (outbox) | `CustomerCreated` → Wallet создаёт кошелёк |

### Query Service

CQRS read model. Строит денормализованные проекции из событий для быстрых запросов.

**Задачи:**

- Подписка на все payment events
- Построение `payment_projections` — одна таблица со всеми данными платежа
- Быстрые запросы без JOIN'ов
- История операций пользователя

**ERD:** [Query DB](database.md#query-db)

**Входящие:**

| От кого | Протокол    | Описание                                                |
| ------- | ----------- | ------------------------------------------------------- |
| BFF     | HTTP (sync) | `GET /payments/{id}`, `GET /payments?walletId=`         |
| Kafka   | async       | `PaymentInitiated`, `PaymentCompleted`, `PaymentFailed` |

**Исходящие:** Нет (read-only)

### Callback Service

Приём callback'ов от внешних провайдеров.

**Задачи:**

- Приём HTTP callback'ов от провайдеров
- Валидация подписи провайдера
- Сохранение callback'а
- Публикация события `ProviderCallbackReceived` для Payment Service

**ERD:** [Callback DB](database.md#callback-db)

**Входящие:**

| От кого     | Протокол  | Описание                  |
| ----------- | --------- | ------------------------- |
| API Gateway | HTTP/REST | Callback'и от провайдеров |

**Исходящие:**

| Куда  | Протокол       | Описание                   |
| ----- | -------------- | -------------------------- |
| Kafka | async (outbox) | `ProviderCallbackReceived` |

### Notification Service

Уведомления клиентам о статусе операций.

**Задачи:**

- Подписка на payment events
- Выбор канала (push, SMS, email) по предпочтениям пользователя
- Rate limiting (не более N уведомлений в час)
- Fallback: если push не доставлен → SMS
- Дедупликация (не отправлять дважды одно уведомление)

**Кэш:** Redis (дедупликация, rate limiting)

**Входящие:**

| От кого | Протокол | Описание                            |
| ------- | -------- | ----------------------------------- |
| Kafka   | async    | `PaymentCompleted`, `PaymentFailed` |

**Исходящие:**

| Куда                      | Протокол | Описание         |
| ------------------------- | -------- | ---------------- |
| Push Gateway (FCM/APNs)   | HTTPS    | Push-уведомления |
| SMS Provider              | HTTPS    | SMS              |
| Email Provider (SendGrid) | HTTPS    | Email            |

### Merchant Callback Service

Отправка callback'ов мерчантам о статусе платежей.

**Задачи:**

- Подписка на payment events
- Доставка callback'ов на URL мерчанта
- Retry с exponential backoff при ошибках
- Хранение истории доставок

**ERD:** [Merchant Callback DB](database.md#merchant-callback-db)

**Входящие:**

| От кого | Протокол | Описание                            |
| ------- | -------- | ----------------------------------- |
| Kafka   | async    | `PaymentCompleted`, `PaymentFailed` |

**Исходящие:**

| Куда      | Протокол | Описание                 |
| --------- | -------- | ------------------------ |
| Merchants | HTTPS    | Payment status callbacks |

### Core Banking Integration

Anti-corruption layer к legacy банковской системе. Переводит события в формат главной книги.

**Задачи:**

- Подписка на `PaymentCompleted`
- Формирование проводок для главной книги
- Адаптация протоколов (REST → SOAP/MQ legacy)
- Regulatory reporting
- Reconciliation с legacy

**Входящие:**

| От кого | Протокол | Описание           |
| ------- | -------- | ------------------ |
| Kafka   | async    | `PaymentCompleted` |

**Исходящие:**

| Куда                | Протокол | Описание |
| ------------------- | -------- | -------- |
| Legacy Core Banking | SOAP/MQ  | Проводки |
