# ADR-003: Хореография через Kafka для Payment Saga

## Статус

Принято

## Контекст

Платёжная платформа требует координации между сервисами (Wallet, Payment, Callback). Два подхода:

**Оркестрация** — центральный координатор (Temporal, Camunda) управляет флоу, вызывает сервисы последовательно, обрабатывает ретраи и компенсации.

**Хореография** — сервисы общаются через события в message broker (Kafka), каждый сервис реагирует на события и публикует новые.

## Решение

Используем **хореографию** через Kafka.

**BFF (Backend for Frontend)**:

- Принимает запросы клиента
- Вызывает `Wallet.reserve()` — sync HTTP
- Читает статус и историю платежей из Query Service (CQRS)
- НЕ вызывает Payment Service напрямую

Дальше работает **Kafka**.

### Почему хореография

- **Kafka уже есть** — события и Transactional Outbox требуют брокер
- **Проще инфраструктура** — не нужен Temporal/Camunda сервер + база

### Почему не оркестрация (Temporal, Camunda)

После вызова `reserve()` BFF возвращает ответ клиенту. Остальное происходит асинхронно через Kafka. BFF простаивал бы в ожидании — workflow engine избыточен.

| Вариант                | Почему нет                                       |
| ---------------------- | ------------------------------------------------ |
| **Temporal**           | Доп. инфраструктура (сервер + БД), overkill      |
| **Camunda**            | BPMN сложность                                   |
| **AWS Step Functions** | Workflows в JSON                                 |

## Последствия

**Положительные:**

- Нет доп. инфраструктуры для workflow engine
- Используем уже имеющийся Kafka

**Отрицательные:**

- Нет центральной видимости состояния саги (нужен хороший logging/tracing)
- Сложнее дебажить
