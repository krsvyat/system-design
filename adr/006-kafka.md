# ADR-006: Kafka как Message Broker

## Статус

Принято

## Контекст

Платформе нужен message broker для асинхронной коммуникации между сервисами. Основные требования:

- Публикация событий (PaymentInitiated, PaymentCompleted, PaymentFailed...)
- Несколько консьюмеров на одно событие (Query, Notification, Wallet...)
- Гарантия порядка событий для одного платежа
- Возможность replay при сбое консьюмера — события хранятся в Kafka, можно перечитать с нужного offset

## Решение

Используем **Kafka** как единственный message broker.

### Почему Kafka

| Требование            | Как решает Kafka         |
| --------------------- | ------------------------ |
| Несколько консьюмеров | Consumer groups          |
| Порядок событий       | Partition by payment_id  |
| Перечитывание         | Retention + offset reset |
| Надёжность            | Репликация               |
| Высокая пропускная    | Да                       |

### Почему не RabbitMQ

RabbitMQ лучше для:

- Work queues — один воркер берёт одну задачу (email рассылка, image processing)
- Priority queues — срочные задачи обрабатываются первыми
- Request-reply — синхронный RPC через очереди

Нам это не нужно. Все наши use cases — pub/sub с несколькими консьюмерами на одно событие.

## Последствия

**Положительные:**

- Один брокер — проще инфраструктура
- Ordering гарантирован через partition key
- Replay при сбоях

**Отрицательные:**

- Сложнее в операционном плане чем RabbitMQ
