# ADR-005: CDC (Debezium) для Transactional Outbox

## Статус

Принято

## Контекст

Transactional Outbox паттерн требует публикации событий из outbox-таблицы в Kafka. Два подхода:

**Polling** — scheduled job периодически читает outbox-таблицу, публикует в Kafka, помечает как отправленные.

**CDC (Change Data Capture)** — Debezium читает PostgreSQL WAL, стримит изменения в Kafka автоматически.

## Решение

Используем **CDC через Debezium** для публикации outbox в Wallet Service, Payment Service и Callback Service.

### Почему CDC

- **Низкая задержка**: события публикуются за миллисекунды (vs polling 100ms-1s)
- **Нет нагрузки от polling**: читает WAL, не таблицу
- **Производительность**: быстрое резервирование и обновление статусов

### Почему Debezium, а не свой CDC

Альтернатива: читать PostgreSQL replication slot напрямую без Debezium.

| Аспект              | Debezium                 | Свой CDC         |
| ------------------- | ------------------------ | ---------------- |
| Отслеживание offset | Kafka Connect управляет  | Надо реализовать |
| Отказоустойчивость  | Встроенная               | Надо реализовать |
| Эволюция схемы      | Поддерживается           | Надо реализовать |
| Инфраструктура      | Kafka Connect + Debezium | Только Kafka     |

Свой CDC убирает зависимость от Kafka Connect, но требует реализации отслеживания offset, отказоустойчивости и обработки схем. Debezium популярен и проверен в бою.

### Компромиссы

| Аспект         | CDC (Debezium)                      | Polling           |
| -------------- | ----------------------------------- | ----------------- |
| Задержка       | ~ms                                 | 100ms-1s          |
| Инфраструктура | Kafka Connect (с Debezium плагином) | Нет               |
| Сложность      | Выше                                | Ниже              |
| Нагрузка на БД | Минимальная (WAL)                   | Постоянные SELECT |

## Последствия

**Положительные:**

- Публикация событий почти в реальном времени
- Нет нагрузки polling на базу

**Отрицательные:**

- Доп. инфраструктура (Kafka Connect с Debezium плагином)
- Сложнее деплоймент и мониторинг
